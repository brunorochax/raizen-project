version: '3.8'
services:
    win-py-runner:
        privileged: true
        tty: true
        image: brunosousax/ubuntukvm:latest
        command: sleep infinity
        restart: on-failure
        ports:  
            - "22:22"
            - "3389:3389"
        volumes:
            - /sys/fs/cgroup:/sys/fs/cgroup:rw
            - ./input_files:/input_files
            - ./output_files:/output_files
        devices:
            - /dev/kvm
            - /dev/net/tun
        cap_add:
            - NET_ADMIN
            - SYS_ADMIN
    postgres:
        image: postgres:13.3
        restart: on-failure
        environment:
            - POSTGRES_USER=airflow
            - POSTGRES_PASSWORD=airflow
            - POSTGRES_DB=airflow
    scheduler:
        image: apache/airflow:2.1.1
        command: scheduler
        restart: on-failure
        depends_on:
            - postgres
        env_file:
            - .env
        volumes:
            - ./pipeline/dags:/opt/airflow/dags
            - ./pipeline/logs:/opt/airflow/logs
            - ./input_files:/input_files
            - ./output_files:/output_files
            - ./airflow.cfg:/opt/airflow/airflow.cfg
    webserver:
        image: apache/airflow:2.1.1
        entrypoint: /entrypoint.sh
        restart: on-failure
        depends_on:
            - postgres
            - scheduler
        env_file:
            - .env
        volumes:
            - ./pipeline/dags:/opt/airflow/dags
            - ./pipeline/logs:/opt/airflow/logs
            - ./scripts:/opt/airflow/scripts
            - ./input_files:/input_files
            - ./output_files:/output_files
            - ./entrypoint.sh:/entrypoint.sh
            - ./airflow.cfg:/opt/airflow/airflow.cfg
        ports:
            - "8080:8080"